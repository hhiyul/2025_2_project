import os
import torch
import torch.nn as nn
from sklearn.model_selection import StratifiedKFold
from tqdm import tqdm
from torchvision import models, transforms
from torch.utils.data import Dataset, DataLoader
from datasets import load_dataset, ClassLabel, DatasetDict
import numpy as np
from torch.amp import autocast, GradScaler
import math
import time
from typing import Optional, Tuple, Dict
import torch.nn.functional as F
from sklearn.metrics import f1_score

device = torch.device("cuda" if torch.cuda.is_available() else "cpu")

train_transform = transforms.Compose([
    transforms.Resize((224,224)),
    transforms.RandomHorizontalFlip(),
    transforms.RandomRotation(15),
    transforms.ToTensor(),
    transforms.Normalize([0.485,0.456,0.406],
                         [0.229,0.224,0.225])
])

val_transform = transforms.Compose([
    transforms.Resize((224,224)),
    transforms.ToTensor(),
    transforms.Normalize([0.485,0.456,0.406],
                         [0.229,0.224,0.225])
])

# ----------------------------------- ì „ì²˜ë¦¬ íŒŒíŠ¸ âˆ¨--------------------------------------
def prepare_dataset():
    dataset = load_dataset("Densu341/Fresh-rotten-fruit")

    # 1ï¸âƒ£ ì œê±°í•  ë¼ë²¨ ì„¤ì •
    remove_labels = [18, 20, 16, 13, 2, 5, 7, 9]
    labels = np.array(dataset["train"]["label"])
    mask = ~np.isin(labels, remove_labels)

    # 2ï¸âƒ£ í•„ìš” ì—†ëŠ” ë¼ë²¨ ì œê±°
    clean_dataset = dataset["train"].select(np.where(mask)[0])

    # 3ï¸âƒ£ Train/Val ë¶„í• 
    dataset = clean_dataset.train_test_split(test_size=0.2)
    train_dataset, val_dataset = dataset["train"], dataset["test"]

    # 4ï¸âƒ£ ì‹¤ì œ ë‚¨ì€ ë¼ë²¨ ë° ì´ë¦„ ì •ë¦¬
    unique_labels = sorted(set(train_dataset["label"]) | set(val_dataset["label"]))
    all_labels = [train_dataset.features["label"].int2str(i) for i in unique_labels]

    new_classlabel = ClassLabel(num_classes=len(all_labels), names=all_labels)

    # 5ï¸âƒ£ ë¼ë²¨ ê°’ ì¬ë§¤í•‘
    def remap_labels(example):
        label_name = train_dataset.features["label"].int2str(example["label"])
        example["label"] = all_labels.index(label_name)
        return example

    print("ğŸ” Remapping labels...")
    train_dataset = train_dataset.map(
        remap_labels,
        num_proc=os.cpu_count() // 2,          # CPU ì ˆë°˜ ë³‘ë ¬ ì²˜ë¦¬
        load_from_cache_file=True,
        desc="Remapping train labels"
    )
    val_dataset = val_dataset.map(
        remap_labels,
        num_proc=os.cpu_count() // 2,
        load_from_cache_file=True,
        desc="Remapping val labels"
    )

    train_dataset = train_dataset.cast_column("label", new_classlabel)
    val_dataset   = val_dataset.cast_column("label", new_classlabel)

    # 6ï¸âƒ£ ì´ë¯¸ì§€ RGB ê³ ì •
    def to_rgb(example):
        img = example["image"]
        if img.mode != "RGB":
            img = img.convert("RGB")
        example["image"] = img
        return example

    print("ğŸ¨ Converting to RGB (parallel, 1íšŒ ì‹¤í–‰)...")
    train_dataset = train_dataset.map(
        to_rgb,
        num_proc=os.cpu_count() // 2,          # ë©€í‹°ì½”ì–´ ë³€í™˜
        load_from_cache_file=True,
        desc="Converting train RGB"
    )
    val_dataset = val_dataset.map(
        to_rgb,
        num_proc=os.cpu_count() // 2,
        load_from_cache_file=True,
        desc="Converting val RGB"
    )

    # 7ï¸âƒ£ ğŸ”¥ Transform + Tensor ìºì‹±
    def map_train_tf(example):
        example["image"] = train_transform(example["image"])
        return example

    def map_val_tf(example):
        example["image"] = val_transform(example["image"])
        return example

    print("âš™ï¸ Applying transforms & caching tensors...")
    train_dataset = train_dataset.map(
        map_train_tf,
        num_proc=os.cpu_count() // 2,          # ğŸ’¥ CPU ë³‘ë ¬ì²˜ë¦¬
        batched=False,                         # PIL ë³€í™˜ì€ ë‹¨ì¼ ìƒ˜í”Œ ì²˜ë¦¬
        load_from_cache_file=True,             # ê¸°ì¡´ ìºì‹œ ìˆìœ¼ë©´ ì¬í™œìš©
        desc="Transforming train images"
    )
    val_dataset = val_dataset.map(
        map_val_tf,
        num_proc=os.cpu_count() // 2,
        batched=False,
        load_from_cache_file=True,
        desc="Transforming val images"
    )

    # 8ï¸âƒ£ Tensor í˜•ì‹ ì§€ì • (HuggingFace â†’ PyTorchìš©)
    train_dataset.set_format(type="torch", columns=["image", "label"])
    val_dataset.set_format(type="torch", columns=["image", "label"])

    final_dataset = DatasetDict({
        "train": train_dataset,
        "test":  val_dataset
    })

    print("âœ… Dataset ready! (Tensor cached)")
    save_path = "C:\\Users\\USER-PC\\Desktop\\deep"
    print(f"ğŸ’¾ Saving final dataset to: {save_path}")
    final_dataset.save_to_disk(save_path)

    return final_dataset
def main():
    final_dataset = prepare_dataset()


if __name__ == "__main__":
    torch.multiprocessing.set_start_method("spawn", force=True)
    main()